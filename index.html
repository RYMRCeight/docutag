<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DocuTag â€“ DOCX Issuance</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
<script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
<script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>

<style>
body{background:#121212;color:white;font-family:Inter,system-ui}
.app-card{background:#181818;border-radius:12px}
.app-input{background:#2a2a2a;color:white}
.btn{background:#22c55e;color:black;font-weight:700;border-radius:999px}
</style>
</head>

<body class="min-h-screen flex flex-col">

<header class="p-6 border-b border-neutral-800">
  <h1 class="text-xl font-bold">DocuTag</h1>
</header>

<main class="flex-grow max-w-5xl mx-auto p-6 grid md:grid-cols-2 gap-6">

<div class="space-y-6">

  <div class="app-card p-6">
    <input type="file" id="file-upload" accept=".docx"
           class="app-input w-full p-3 rounded">
    <p id="file-name" class="text-xs text-neutral-400 mt-2">No file selected</p>
  </div>

  <div class="app-card p-6 space-y-4">
    <input id="doc-number" class="app-input w-full p-3 rounded font-mono"
           placeholder="Reference Number">

    <input type="datetime-local" id="doc-date"
           class="app-input w-full p-3 rounded">

    <select id="released-by" class="app-input w-full p-3 rounded">
      <option>Norlyn M. Antaran</option>
      <option selected>Reymarc Jason T. Tampos</option>
      <option>Recille R. Ezar</option>
      <option>Regine T. Regalado</option>
    </select>

    <button onclick="processWordDocument()" class="btn w-full py-3">
      STAMP WORD
    </button>

    <button id="download-btn" onclick="downloadWord()"
      class="hidden w-full py-3 border border-green-500 text-green-400 font-bold rounded-full">
      DOWNLOAD DOCX
    </button>
  </div>
</div>

<div class="app-card p-4 overflow-auto">
  <div id="preview" class="bg-white p-4 rounded"></div>
</div>

</main>

<script>
let sourceFile = null;
let processedDocxBlob = null;

const fileInput = document.getElementById("file-upload");
const fileNameEl = document.getElementById("file-name");
const docNumberEl = document.getElementById("doc-number");
const docDateEl = document.getElementById("doc-date");
const releasedByEl = document.getElementById("released-by");
const previewEl = document.getElementById("preview");
const downloadBtn = document.getElementById("download-btn");

/* ðŸ‡µðŸ‡­ PHILIPPINE STANDARD TIME AUTO-FILL */
function setPhilippineDateTime() {
  const now = new Date();
  const pst = new Date(now.getTime() + (8 * 60 * 60 * 1000));
  docDateEl.value = pst.toISOString().slice(0,16);
}
setPhilippineDateTime();

/* FILE LOAD */
fileInput.addEventListener("change", e => {
  sourceFile = e.target.files[0];
  if (!sourceFile) return;
  fileNameEl.textContent = sourceFile.name;
  docNumberEl.value = sourceFile.name.replace(/\.[^/.]+$/, "");
});

/* QR GENERATION */
async function generateQRBase64() {
  const ref = docNumberEl.value.trim();
  const by = releasedByEl.value;
  const dateObj = new Date(docDateEl.value);

  const dateStr = dateObj.toLocaleString("en-US", {
    month:"short", day:"numeric", year:"numeric",
    hour:"numeric", minute:"numeric", hour12:true,
    timeZone: "Asia/Manila"
  });

  const qrURL =
    `https://rymrceight.github.io/verifier/` +
    `?ref=${encodeURIComponent(ref)}` +
    `&by=${encodeURIComponent(by)}` +
    `&date=${encodeURIComponent(dateStr)}`;

  const dataURL = await QRCode.toDataURL(qrURL,{ width:500 });
  return dataURL.split(",")[1];
}

/* WORD PROCESSING */
async function processWordDocument() {
  if (!sourceFile) return alert("Upload a DOCX file first.");

  const qrBase64 = await generateQRBase64();
  const zip = await JSZip.loadAsync(sourceFile);

  zip.file("word/media/docutag_qr.png", qrBase64, { base64:true });

  let ct = await zip.file("[Content_Types].xml").async("string");
  if (!ct.includes("image/png")) {
    ct = ct.replace("</Types>",
      '<Default Extension="png" ContentType="image/png"/></Types>');
    zip.file("[Content_Types].xml", ct);
  }

  const relsPath = "word/_rels/document.xml.rels";
  let rels = await zip.file(relsPath).async("string");
  const rId = "rIdDocuTag" + Math.floor(Math.random()*100000);

  rels = rels.replace("</Relationships>",
    `<Relationship Id="${rId}"
     Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image"
     Target="media/docutag_qr.png"/></Relationships>`);

  zip.file(relsPath, rels);

  const docPrId = Math.floor(Math.random()*100000);

  const anchor = `
<w:p xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
<w:pPr><w:spacing w:before="0" w:after="0" w:line="0"/></w:pPr>
<w:r><w:drawing>
<wp:anchor xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
 xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
 xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
 simplePos="0" relativeHeight="0" behindDoc="0"
 locked="0" layoutInCell="1" allowOverlap="1">

<wp:positionH relativeFrom="page"><wp:align>right</wp:align></wp:positionH>
<wp:positionV relativeFrom="page"><wp:align>bottom</wp:align></wp:positionV>

<wp:extent cx="700000" cy="700000"/>
<wp:wrapNone/>

<wp:docPr id="${docPrId}" name="DocuTag QR"/>

<a:graphic>
<a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
<pic:pic>
<pic:blipFill>
<a:blip r:embed="${rId}"/>
<a:stretch><a:fillRect/></a:stretch>
</pic:blipFill>
<pic:spPr>
<a:xfrm><a:ext cx="700000" cy="700000"/></a:xfrm>
</pic:spPr>
</pic:pic>
</a:graphicData>
</a:graphic>

</wp:anchor>
</w:drawing></w:r></w:p>`;

  let docXml = await zip.file("word/document.xml").async("string");
  docXml = docXml.replace("</w:body>", anchor + "</w:body>");
  zip.file("word/document.xml", docXml);

  processedDocxBlob = await zip.generateAsync({ type:"blob" });

  previewEl.innerHTML = "";
  await docx.renderAsync(await processedDocxBlob.arrayBuffer(), previewEl);
  downloadBtn.classList.remove("hidden");
}

function downloadWord() {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(processedDocxBlob);
  a.download = docNumberEl.value + "_Stamped.docx";
  a.click();
}
</script>

</body>
</html>
